name: Auto Generate Connector

on:
  workflow_call:
    inputs:
      openapi-url:
        required: true
        type: string
      ballerina-version:
        required: false
        type: string
        default: "2201.13.0"
      quiet-mode:
        required: false
        type: boolean
        default: true
    secrets:
      BALLERINA_BOT_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: true

jobs:
  generate:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BALLERINA_BOT_TOKEN }}

      - name: Setup Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.3
        with:
          version: ${{ inputs.ballerina-version }}

      - name: Configure Git
        run: |
          git config user.name "ballerina-bot"
          git config user.email "ballerina-bot@ballerina.org"

      - name: Download OpenAPI spec
        run: |
          mkdir -p docs/spec
          curl -L "${{ inputs.openapi-url }}" -o docs/spec/openapi.yaml

      # ✅ CLONE YOUR OWN STABLE FORK — NOT nostoc
      - name: Clone connector automator
        run: |
          git clone https://github.com/TharaniDJ/ballerina-library.git temp
          cp -r temp/connector_automator .
          rm -rf temp

      - name: Patch connector automator (license substring crash)
        run: |
          # Upstream bug: `licenseFile` is always a `string`, so `if licenseFile is string` is always true.
          # When no license option is provided, `licenseFile` is "" and `substring(8)` crashes.
          perl -pi -e 's/if\s+licenseFile\s+is\s+string\s*\{/if licenseFile.length() > 0 {/' connector_automator/main.bal
          # Fail fast if the expected fix did not apply (prevents a confusing runtime crash later).
          if grep -n "if licenseFile is string" connector_automator/main.bal; then
            echo "Patch did not apply; connector_automator/main.bal still contains: if licenseFile is string" >&2
            exit 1
          fi

      - name: Verify automator builds
        run: |
          cd connector_automator
          bal build

      - name: Prepare connector output directory
        run: |
          # `bal openapi --mode client -o <dir>` expects the output directory to exist.
          mkdir -p "${GITHUB_WORKSPACE}/ballerina"

          # The connector_automator pipeline later runs `bal build` inside `${GITHUB_WORKSPACE}/ballerina`.
          # `bal build` requires a Ballerina package (i.e., a `Ballerina.toml`).
          # The OpenAPI client generator may emit only `*.bal` files, so we scaffold the package upfront.
          if [ ! -f "${GITHUB_WORKSPACE}/ballerina/Ballerina.toml" ]; then
            cat > "${GITHUB_WORKSPACE}/ballerina/Ballerina.toml" <<'EOF'
              [package]
              org = "ballerina_library_test"
              name = "generated_connector"
              version = "0.1.0"

              [build-options]
              observabilityIncluded = true
              EOF
          fi

      - name: Run connector generation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd connector_automator

          cat > Config.toml <<EOF
          [connector_automator.utils]
          apiKey="${ANTHROPIC_API_KEY}"

          [connector_automator.code_fixer]
          maxIterations = 3
          EOF

          bal run -- pipeline \
            "${GITHUB_WORKSPACE}/docs/spec/openapi.yaml" \
            "${GITHUB_WORKSPACE}" \
            yes \
            ${{ inputs.quiet-mode && 'quiet' || '' }}

      - name: Cleanup
        run: |
          rm -rf connector_automator
          find . -name "Dependencies.toml" -delete
          find . -name "*.backup" -delete
          find . -name "target" -type d -exec rm -rf {} +

      - name: Create branch & commit
        run: |
          git checkout -b auto-generate-connector
          git add .
          git commit -m "[AUTOMATED][AI] Generate connector from OpenAPI" || echo "No changes"

      - name: Push branch
        run: git push origin auto-generate-connector
        env:
          GITHUB_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}

      - name: Create Pull Request
        run: |
          gh pr create \
            --title "[AUTOMATED][AI] Generate connector from OpenAPI" \
            --body "⚠️ AI-generated connector. Manual review required before merge." \
            --base main \
            --head auto-generate-connector
        env:
          GITHUB_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}
